name: Security Scan

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  secret-scan:
    name: Secret & PII Detection
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Scan for secrets and API keys
        run: |
          echo "=== Scanning for secrets and API keys ==="
          FOUND=0
          SCAN_INCLUDES="--include=*.md --include=*.json --include=*.json5 --include=*.js --include=*.py --include=*.sh --include=*.yml --include=*.yaml --include=*.lobster --include=*.txt"
          SCAN_EXCLUDES="--exclude-dir=.git --exclude-dir=node_modules --exclude=security-scan.yml"

          # Each pattern: "label|regex"
          PATTERNS=(
            "OpenAI API key|sk-(?:proj-)?[a-zA-Z0-9_-]{20,}"
            "Slack bot token|xoxb-[0-9]{10,}-[0-9A-Za-z-]+"
            "Slack user token|xoxp-[0-9]{10,}-[0-9A-Za-z-]+"
            "Slack app token|xapp-[0-9]-[0-9A-Za-z-]{20,}"
            "GitHub PAT|ghp_[0-9A-Za-z]{36}"
            "GitHub user token|ghu_[0-9A-Za-z]{36}"
            "AWS access key|AKIA[0-9A-Z]{16}"
            "Bearer token|Bearer\s+[a-zA-Z0-9._-]{20,}"
            "Private key header|-----BEGIN (RSA |EC |DSA )?PRIVATE KEY-----"
            "Anthropic API key|sk-ant-[a-zA-Z0-9-]{20,}"
            "Linear API key|lin_api_[a-zA-Z0-9]{30,}"
            "Perplexity API key|pplx-[a-zA-Z0-9]{40,}"
          )

          for entry in "${PATTERNS[@]}"; do
            LABEL="${entry%%|*}"
            REGEX="${entry#*|}"
            HITS=$(grep -rPn "$REGEX" $SCAN_INCLUDES $SCAN_EXCLUDES . 2>/dev/null \
              | grep -v 'YOUR_\|PLACEHOLDER\|example\|changeme\|sk-proj-\.\.\.' \
              | grep -v '# .*pattern\|# .*regex\|# .*scan\|PATTERNS\|REGEX' || true)
            if [ -n "$HITS" ]; then
              echo "$HITS"
              echo "::error::BLOCKED: Found potential $LABEL"
              FOUND=1
            fi
          done

          if [ "$FOUND" -eq 1 ]; then
            echo "::error::Secret scan failed — remove all secrets before merging."
            exit 1
          fi
          echo "✅ No secrets found."

      - name: Scan for PII
        run: |
          echo "=== Scanning for PII ==="
          FOUND=0
          SCAN_INCLUDES="--include=*.md --include=*.json --include=*.json5 --include=*.js --include=*.py --include=*.sh --include=*.lobster"
          SCAN_EXCLUDES="--exclude-dir=.git --exclude-dir=node_modules --exclude=security-scan.yml"

          # Real email addresses (require word-char before @, valid TLD)
          # Exclude: placeholders, generic docs patterns, code comments about email
          EMAIL_HITS=$(grep -rPn '\b[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}\b' $SCAN_INCLUDES $SCAN_EXCLUDES . 2>/dev/null \
            | grep -v 'example\.com\|placeholder\.com\|yourdomain\.com\|you@gmail\.com\|your-email@' \
            | grep -v '"email":\|"calendar":\|# .*@\|//.*@' || true)
          if [ -n "$EMAIL_HITS" ]; then
            echo "$EMAIL_HITS"
            echo "::error::BLOCKED: Found real email addresses"
            FOUND=1
          fi

          # Private/Tailscale IPs (real addresses, not in comments/docs about IP ranges)
          IP_HITS=$(grep -rPn '\b(?:192\.168\.\d{1,3}\.\d{1,3}|10\.\d{1,3}\.\d{1,3}\.\d{1,3}|100\.\d{1,3}\.\d{1,3}\.\d{1,3}|172\.(?:1[6-9]|2\d|3[01])\.\d{1,3}\.\d{1,3})\b' $SCAN_INCLUDES $SCAN_EXCLUDES . 2>/dev/null \
            | grep -v '# .*example\|//.*example\|0\.0\.0\.0' || true)
          if [ -n "$IP_HITS" ]; then
            echo "$IP_HITS"
            echo "::error::BLOCKED: Found private/internal IP addresses"
            FOUND=1
          fi

          # LinkedIn URN with real ID
          URN_HITS=$(grep -rPn 'urn:li:person:[a-zA-Z0-9]{5,}' $SCAN_INCLUDES $SCAN_EXCLUDES . 2>/dev/null \
            | grep -v 'urn:li:person:\.\.\.' || true)
          if [ -n "$URN_HITS" ]; then
            echo "$URN_HITS"
            echo "::error::BLOCKED: Found LinkedIn URN"
            FOUND=1
          fi

          if [ "$FOUND" -eq 1 ]; then
            echo "::error::PII scan failed — remove personal data before merging."
            exit 1
          fi
          echo "✅ No PII found."

      - name: Scan for hardcoded infrastructure IDs
        run: |
          echo "=== Scanning for infrastructure IDs ==="
          FOUND=0
          SCAN_INCLUDES="--include=*.md --include=*.json --include=*.json5 --include=*.js --include=*.py --include=*.sh --include=*.lobster"
          SCAN_EXCLUDES="--exclude-dir=.git --exclude-dir=node_modules --exclude=security-scan.yml"

          # Notion-style UUIDs (8-4-4-4-12 hex)
          UUID_HITS=$(grep -rPn '[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}' $SCAN_INCLUDES $SCAN_EXCLUDES . 2>/dev/null \
            | grep -v 'YOUR_\|PLACEHOLDER\|00000000-0000-0000-0000-000000000000' || true)
          if [ -n "$UUID_HITS" ]; then
            echo "$UUID_HITS"
            echo "::error::BLOCKED: Found potential real UUIDs"
            FOUND=1
          fi

          if [ "$FOUND" -eq 1 ]; then
            echo "::error::Infrastructure ID scan failed."
            exit 1
          fi
          echo "✅ No hardcoded infrastructure IDs found."

      - name: Verify placeholders exist
        run: |
          echo "=== Checking placeholder conventions ==="
          for PH in YOUR_DISCORD_CHANNEL_ID YOUR_NOTION_DATABASE_ID YOUR_X_HANDLE; do
            COUNT=$(grep -r "$PH" --include='*.md' --include='*.json5' --include='*.js' --exclude-dir='.git' . 2>/dev/null | wc -l)
            [ "$COUNT" -gt 0 ] && echo "✓ $PH found ($COUNT)"
          done
          echo "Placeholder check complete."
